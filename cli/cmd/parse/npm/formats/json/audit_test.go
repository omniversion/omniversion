package json

import (
	"github.com/omniversion/omniversion/cli/cmd/parse/npm/formats"
	"github.com/omniversion/omniversion/cli/cmd/parse/npm/stderr"
	"github.com/omniversion/omniversion/cli/cmd/parse/shared"
	"github.com/stretchr/testify/assert"
	"testing"
)

func TestParseAuditOutput_NoLockfile(t *testing.T) {
	vector := "npm ERR! code ENOLOCK\nnpm ERR! audit This command requires an existing lockfile.\nnpm ERR! audit Try creating one first with: npm i --package-lock-only\nnpm ERR! audit Original error: loadVirtual requires existing shrinkwrap file\n{\n  \"error\": {\n    \"code\": \"ENOLOCK\",\n    \"summary\": \"This command requires an existing lockfile.\",\n    \"detail\": \"Try creating one first with: npm i --package-lock-only\\nOriginal error: loadVirtual requires existing shrinkwrap file\"\n  }\n}\n\nnpm ERR! A complete log of this run can be found in:\nnpm ERR!     /Users/testor/.npm/_logs/2022-05-09T07_10_18_532Z-debug.log\n"

	strippedInput, stderrOutput, _ := stderr.Strip(vector)
	verb, format := formats.DetectVerbAndFormat(strippedInput, stderrOutput)
	assert.Equal(t, formats.AuditCommand, verb)
	assert.Equal(t, formats.JsonFormat, format)

	previousInjectValue := shared.InjectPackageManager
	defer func() { shared.InjectPackageManager = previousInjectValue }()
	shared.InjectPackageManager = true
	result, err := ParseAuditOutput(strippedInput, stderrOutput)

	assert.NotNil(t, err)
	assert.Equal(t, "this command requires an existing lockfile", err.Error())
	assert.Equal(t, 0, len(result))
}

func TestParseAuditOutput(t *testing.T) {
	vector := "{\n  \"auditReportVersion\": 2,\n  \"vulnerabilities\": {\n    \"@angular-devkit/build-angular\": {\n      \"name\": \"@angular-devkit/build-angular\",\n      \"severity\": \"high\",\n      \"isDirect\": true,\n      \"via\": [\n        \"webpack-dev-server\"\n      ],\n      \"effects\": [],\n      \"range\": \"<=13.2.0-rc.1\",\n      \"nodes\": [\n        \"node_modules/@angular-devkit/build-angular\"\n      ],\n      \"fixAvailable\": true\n    },\n    \"async\": {\n      \"name\": \"async\",\n      \"severity\": \"high\",\n      \"isDirect\": false,\n      \"via\": [\n        {\n          \"source\": 1070206,\n          \"name\": \"async\",\n          \"dependency\": \"async\",\n          \"title\": \"Prototype Pollution in async\",\n          \"url\": \"https://github.com/advisories/GHSA-fwr7-v2mv-hh25\",\n          \"severity\": \"high\",\n          \"range\": \"<2.6.4\"\n        },\n        {\n          \"source\": 1070207,\n          \"name\": \"async\",\n          \"dependency\": \"async\",\n          \"title\": \"Prototype Pollution in async\",\n          \"url\": \"https://github.com/advisories/GHSA-fwr7-v2mv-hh25\",\n          \"severity\": \"high\",\n          \"range\": \">=3.0.0 <3.2.2\"\n        }\n      ],\n      \"effects\": [\n        \"jake\",\n        \"mail-listener2\",\n        \"pdf2json\"\n      ],\n      \"range\": \">=3.0.0 <3.2.2 || <2.6.4\",\n      \"nodes\": [\n        \"node_modules/async\",\n        \"node_modules/jake/node_modules/async\",\n        \"node_modules/mail-listener2/node_modules/async\",\n        \"node_modules/pdf2json/node_modules/async\",\n        \"node_modules/portfinder/node_modules/async\",\n        \"node_modules/protractor-jasmine2-html-reporter/node_modules/async\"\n      ],\n      \"fixAvailable\": {\n        \"name\": \"pdf2json\",\n        \"version\": \"2.0.1\",\n        \"isSemVerMajor\": true\n      }\n    },\n    \"ejs\": {\n      \"name\": \"ejs\",\n      \"severity\": \"high\",\n      \"isDirect\": false,\n      \"via\": [\n        {\n          \"source\": 1070256,\n          \"name\": \"ejs\",\n          \"dependency\": \"ejs\",\n          \"title\": \"Template injection in ejs\",\n          \"url\": \"https://github.com/advisories/GHSA-phwq-j96m-2c2q\",\n          \"severity\": \"high\",\n          \"range\": \"<3.1.7\"\n        }\n      ],\n      \"effects\": [],\n      \"range\": \"<3.1.7\",\n      \"nodes\": [\n        \"node_modules/ejs\"\n      ],\n      \"fixAvailable\": true\n    },\n    \"jake\": {\n      \"name\": \"jake\",\n      \"severity\": \"high\",\n      \"isDirect\": false,\n      \"via\": [\n        \"async\"\n      ],\n      \"effects\": [],\n      \"range\": \"8.0.1 - 10.8.4\",\n      \"nodes\": [\n        \"node_modules/jake\"\n      ],\n      \"fixAvailable\": true\n    },\n    \"mail-listener2\": {\n      \"name\": \"mail-listener2\",\n      \"severity\": \"high\",\n      \"isDirect\": true,\n      \"via\": [\n        \"async\"\n      ],\n      \"effects\": [],\n      \"range\": \">=0.1.5\",\n      \"nodes\": [\n        \"node_modules/mail-listener2\"\n      ],\n      \"fixAvailable\": {\n        \"name\": \"mail-listener2\",\n        \"version\": \"0.1.4\",\n        \"isSemVerMajor\": true\n      }\n    },\n    \"minimist\": {\n      \"name\": \"minimist\",\n      \"severity\": \"critical\",\n      \"isDirect\": false,\n      \"via\": [\n        {\n          \"source\": 1067342,\n          \"name\": \"minimist\",\n          \"dependency\": \"minimist\",\n          \"title\": \"Prototype Pollution in minimist\",\n          \"url\": \"https://github.com/advisories/GHSA-xvch-5gv4-984h\",\n          \"severity\": \"critical\",\n          \"range\": \"<1.2.6\"\n        }\n      ],\n      \"effects\": [],\n      \"range\": \"<1.2.6\",\n      \"nodes\": [\n        \"node_modules/minimist\"\n      ],\n      \"fixAvailable\": true\n    },\n    \"moment\": {\n      \"name\": \"moment\",\n      \"severity\": \"high\",\n      \"isDirect\": true,\n      \"via\": [\n        {\n          \"source\": 1070245,\n          \"name\": \"moment\",\n          \"dependency\": \"moment\",\n          \"title\": \"Path Traversal: 'dir/../../filename' in moment.locale\",\n          \"url\": \"https://github.com/advisories/GHSA-8hfj-j24r-96c4\",\n          \"severity\": \"high\",\n          \"range\": \"<2.29.2\"\n        }\n      ],\n      \"effects\": [],\n      \"range\": \"<2.29.2\",\n      \"nodes\": [\n        \"node_modules/moment\"\n      ],\n      \"fixAvailable\": true\n    },\n    \"node-forge\": {\n      \"name\": \"node-forge\",\n      \"severity\": \"high\",\n      \"isDirect\": false,\n      \"via\": [\n        {\n          \"source\": 1067364,\n          \"name\": \"node-forge\",\n          \"dependency\": \"node-forge\",\n          \"title\": \"Improper Verification of Cryptographic Signature in node-forge\",\n          \"url\": \"https://github.com/advisories/GHSA-cfm4-qjh2-4765\",\n          \"severity\": \"high\",\n          \"range\": \"<1.3.0\"\n        }\n      ],\n      \"effects\": [\n        \"selfsigned\"\n      ],\n      \"range\": \"<1.3.0\",\n      \"nodes\": [\n        \"node_modules/node-forge\"\n      ],\n      \"fixAvailable\": true\n    },\n    \"pdf2json\": {\n      \"name\": \"pdf2json\",\n      \"severity\": \"high\",\n      \"isDirect\": true,\n      \"via\": [\n        \"async\"\n      ],\n      \"effects\": [],\n      \"range\": \"0.2.6 - 0.7.1 || 1.2.0 - 1.3.1\",\n      \"nodes\": [\n        \"node_modules/pdf2json\"\n      ],\n      \"fixAvailable\": {\n        \"name\": \"pdf2json\",\n        \"version\": \"2.0.1\",\n        \"isSemVerMajor\": true\n      }\n    },\n    \"selfsigned\": {\n      \"name\": \"selfsigned\",\n      \"severity\": \"high\",\n      \"isDirect\": false,\n      \"via\": [\n        \"node-forge\"\n      ],\n      \"effects\": [\n        \"webpack-dev-server\"\n      ],\n      \"range\": \"1.1.1 - 1.10.14\",\n      \"nodes\": [\n        \"node_modules/selfsigned\"\n      ],\n      \"fixAvailable\": true\n    },\n    \"webpack-dev-server\": {\n      \"name\": \"webpack-dev-server\",\n      \"severity\": \"high\",\n      \"isDirect\": false,\n      \"via\": [\n        \"selfsigned\"\n      ],\n      \"effects\": [\n        \"@angular-devkit/build-angular\"\n      ],\n      \"range\": \"2.5.0 - 4.7.2\",\n      \"nodes\": [\n        \"node_modules/webpack-dev-server\"\n      ],\n      \"fixAvailable\": true\n    }\n  },\n  \"metadata\": {\n    \"vulnerabilities\": {\n      \"info\": 0,\n      \"low\": 0,\n      \"moderate\": 0,\n      \"high\": 10,\n      \"critical\": 1,\n      \"total\": 11\n    },\n    \"dependencies\": {\n      \"prod\": 524,\n      \"dev\": 1297,\n      \"optional\": 48,\n      \"peer\": 5,\n      \"peerOptional\": 0,\n      \"total\": 1830\n    }\n  }\n}"

	verb, format := formats.DetectVerbAndFormat(vector, stderr.Output{})
	assert.Equal(t, formats.AuditCommand, verb)
	assert.Equal(t, formats.JsonFormat, format)

	previousInjectValue := shared.InjectPackageManager
	defer func() { shared.InjectPackageManager = previousInjectValue }()
	shared.InjectPackageManager = true
	result, err := ParseAuditOutput(vector, stderr.Output{})

	assert.Nil(t, err)
	assert.Equal(t, 11, len(result))

	item := result[1]
	assert.Equal(t, "npm", item.PackageManager)
	assert.Equal(t, "async", item.Name)
	assert.Equal(t, "", item.Current)
	assert.Equal(t, 2, len(item.Advisories))

	advisory := item.Advisories[0]
	assert.Equal(t, 0.0, advisory.CVSSScore)
	assert.Equal(t, "1070206", advisory.Identifier)
	assert.Equal(t, "", advisory.Overview)
	assert.Equal(t, "", advisory.PatchedVersions)
	assert.Equal(t, "", advisory.Recommendation)
	assert.Equal(t, "high", advisory.Severity)
	assert.Equal(t, "Prototype Pollution in async", advisory.Title)
	assert.Equal(t, "https://github.com/advisories/GHSA-fwr7-v2mv-hh25", advisory.Url)
	assert.Equal(t, "<2.6.4", advisory.VulnerableVersions)

	advisory = item.Advisories[1]
	assert.Equal(t, 0.0, advisory.CVSSScore)
	assert.Equal(t, "1070207", advisory.Identifier)
	assert.Equal(t, "", advisory.Overview)
	assert.Equal(t, "", advisory.PatchedVersions)
	assert.Equal(t, "", advisory.Recommendation)
	assert.Equal(t, "high", advisory.Severity)
	assert.Equal(t, "Prototype Pollution in async", advisory.Title)
	assert.Equal(t, "https://github.com/advisories/GHSA-fwr7-v2mv-hh25", advisory.Url)
	assert.Equal(t, ">=3.0.0 <3.2.2", advisory.VulnerableVersions)
}

func TestParseAuditOutput_V6(t *testing.T) {
	vector := "{\n  \"actions\": [\n    {\n      \"isMajor\": true,\n      \"action\": \"install\",\n      \"resolves\": [\n        {\n          \"id\": 1070207,\n          \"path\": \"pdf2json>async\",\n          \"dev\": true,\n          \"optional\": false,\n          \"bundled\": true\n        }\n      ],\n      \"module\": \"pdf2json\",\n      \"target\": \"2.0.1\"\n    },\n    {\n      \"action\": \"update\",\n      \"resolves\": [\n        {\n          \"id\": 1067323,\n          \"path\": \"@angular-devkit/build-angular>webpack-dev-server>selfsigned>node-forge\",\n          \"dev\": true,\n          \"optional\": false,\n          \"bundled\": false\n        },\n        {\n          \"id\": 1067363,\n          \"path\": \"@angular-devkit/build-angular>webpack-dev-server>selfsigned>node-forge\",\n          \"dev\": true,\n          \"optional\": false,\n          \"bundled\": false\n        },\n        {\n          \"id\": 1067364,\n          \"path\": \"@angular-devkit/build-angular>webpack-dev-server>selfsigned>node-forge\",\n          \"dev\": true,\n          \"optional\": false,\n          \"bundled\": false\n        }\n      ],\n      \"module\": \"node-forge\",\n      \"target\": \"1.3.1\",\n      \"depth\": 4\n    },\n    {\n      \"action\": \"update\",\n      \"resolves\": [\n        {\n          \"id\": 1067342,\n          \"path\": \"webdriver-manager>minimist\",\n          \"dev\": true,\n          \"optional\": false,\n          \"bundled\": false\n        },\n        {\n          \"id\": 1067342,\n          \"path\": \"ng2-validation>libphonenumber-js>minimist\",\n          \"dev\": false,\n          \"optional\": false,\n          \"bundled\": false\n        },\n        {\n          \"id\": 1067342,\n          \"path\": \"@angular/compiler-cli>@babel/core>json5>minimist\",\n          \"dev\": false,\n          \"optional\": false,\n          \"bundled\": false\n        },\n        {\n          \"id\": 1067342,\n          \"path\": \"karma-typescript>istanbul-lib-instrument>@babel/core>json5>minimist\",\n          \"dev\": true,\n          \"optional\": false,\n          \"bundled\": false\n        },\n        {\n          \"id\": 1067342,\n          \"path\": \"@angular-devkit/build-angular>babel-plugin-istanbul>istanbul-lib-instrument>@babel/core>json5>minimist\",\n          \"dev\": true,\n          \"optional\": false,\n          \"bundled\": false\n        },\n        {\n          \"id\": 1067342,\n          \"path\": \"pdfmake>svg-to-pdfkit>pdfkit>linebreak>brfs>quote-stream>minimist\",\n          \"dev\": false,\n          \"optional\": false,\n          \"bundled\": false\n        }\n      ],\n      \"module\": \"minimist\",\n      \"target\": \"1.2.6\",\n      \"depth\": 7\n    },\n    {\n      \"action\": \"update\",\n      \"resolves\": [\n        {\n          \"id\": 1070206,\n          \"path\": \"@angular-eslint/builder>@nrwl/devkit>ejs>jake>async\",\n          \"dev\": true,\n          \"optional\": false,\n          \"bundled\": false\n        },\n        {\n          \"id\": 1070256,\n          \"path\": \"@angular-eslint/builder>@nrwl/devkit>ejs\",\n          \"dev\": true,\n          \"optional\": false,\n          \"bundled\": false\n        }\n      ],\n      \"module\": \"ejs\",\n      \"target\": \"3.1.7\",\n      \"depth\": 3\n    },\n    {\n      \"action\": \"update\",\n      \"resolves\": [\n        {\n          \"id\": 1070207,\n          \"path\": \"karma-typescript>async\",\n          \"dev\": true,\n          \"optional\": false,\n          \"bundled\": false\n        }\n      ],\n      \"module\": \"async\",\n      \"target\": \"3.2.3\",\n      \"depth\": 2\n    },\n    {\n      \"action\": \"update\",\n      \"resolves\": [\n        {\n          \"id\": 1070245,\n          \"path\": \"moment\",\n          \"dev\": false,\n          \"optional\": false,\n          \"bundled\": false\n        }\n      ],\n      \"module\": \"moment\",\n      \"target\": \"2.29.3\",\n      \"depth\": 1\n    },\n    {\n      \"action\": \"review\",\n      \"module\": \"async\",\n      \"resolves\": [\n        {\n          \"id\": 1070206,\n          \"path\": \"@angular-devkit/build-angular>webpack-dev-server>portfinder>async\",\n          \"dev\": true,\n          \"optional\": false,\n          \"bundled\": false\n        },\n        {\n          \"id\": 1070206,\n          \"path\": \"mail-listener2>async\",\n          \"dev\": true,\n          \"optional\": false,\n          \"bundled\": false\n        },\n        {\n          \"id\": 1070206,\n          \"path\": \"protractor-jasmine2-parallel-html-reporter>protractor-jasmine2-html-reporter>async\",\n          \"dev\": true,\n          \"optional\": false,\n          \"bundled\": false\n        }\n      ]\n    }\n  ],\n  \"advisories\": {\n    \"1067323\": {\n      \"findings\": [\n        {\n          \"version\": \"1.2.0\",\n          \"paths\": [\n            \"@angular-devkit/build-angular>webpack-dev-server>selfsigned>node-forge\"\n          ]\n        }\n      ],\n      \"metadata\": null,\n      \"vulnerable_versions\": \"<1.3.0\",\n      \"module_name\": \"node-forge\",\n      \"severity\": \"high\",\n      \"github_advisory_id\": \"GHSA-x4jg-mjrx-434g\",\n      \"cves\": [\n        \"CVE-2022-24772\"\n      ],\n      \"access\": \"public\",\n      \"patched_versions\": \">=1.3.0\",\n      \"cvss\": {\n        \"score\": 7.5,\n        \"vectorString\": \"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N\"\n      },\n      \"updated\": \"2022-03-30T20:07:57.000Z\",\n      \"recommendation\": \"Upgrade to version 1.3.0 or later\",\n      \"cwe\": [\n        \"CWE-347\"\n      ],\n      \"found_by\": null,\n      \"deleted\": null,\n      \"id\": 1067323,\n      \"references\": \"- https://github.com/digitalbazaar/forge/security/advisories/GHSA-x4jg-mjrx-434g\\n- https://nvd.nist.gov/vuln/detail/CVE-2022-24772\\n- https://github.com/digitalbazaar/forge/commit/3f0b49a0573ef1bb7af7f5673c0cfebf00424df1\\n- https://github.com/digitalbazaar/forge/commit/bb822c02df0b61211836472e29b9790cc541cdb2\\n- https://github.com/advisories/GHSA-x4jg-mjrx-434g\",\n      \"created\": \"2022-03-18T23:10:28.000Z\",\n      \"reported_by\": null,\n      \"title\": \"Improper Verification of Cryptographic Signature in node-forge\",\n      \"npm_advisory_id\": null,\n      \"overview\": \"### Impact\\n\\nRSA PKCS#1 v1.5 signature verification code does not check for tailing garbage bytes after decoding a `DigestInfo` ASN.1 structure. This can allow padding bytes to be removed and garbage data added to forge a signature when a low public exponent is being used.\\n\\n### Patches\\n\\nThe issue has been addressed in `node-forge` `1.3.0`.\\n\\n### References\\n\\nFor more information, please see\\n[\\\"Bleichenbacher's RSA signature forgery based on implementation error\\\"](https://mailarchive.ietf.org/arch/msg/openpgp/5rnE9ZRN1AokBVj3VqblGlP63QE/)\\nby Hal Finney.\\n\\n### For more information\\n\\nIf you have any questions or comments about this advisory:\\n* Open an issue in [forge](https://github.com/digitalbazaar/forge)\\n* Email us at [example email address](mailto:security@digitalbazaar.com)\",\n      \"url\": \"https://github.com/advisories/GHSA-x4jg-mjrx-434g\"\n    },\n    \"1067342\": {\n      \"findings\": [\n        {\n          \"version\": \"1.2.5\",\n          \"paths\": [\n            \"webdriver-manager>minimist\",\n            \"ng2-validation>libphonenumber-js>minimist\",\n            \"@angular/compiler-cli>@babel/core>json5>minimist\",\n            \"karma-typescript>istanbul-lib-instrument>@babel/core>json5>minimist\",\n            \"@angular-devkit/build-angular>babel-plugin-istanbul>istanbul-lib-instrument>@babel/core>json5>minimist\",\n            \"pdfmake>svg-to-pdfkit>pdfkit>linebreak>brfs>quote-stream>minimist\"\n          ]\n        }\n      ],\n      \"metadata\": null,\n      \"vulnerable_versions\": \"<1.2.6\",\n      \"module_name\": \"minimist\",\n      \"severity\": \"critical\",\n      \"github_advisory_id\": \"GHSA-xvch-5gv4-984h\",\n      \"cves\": [\n        \"CVE-2021-44906\"\n      ],\n      \"access\": \"public\",\n      \"patched_versions\": \">=1.2.6\",\n      \"cvss\": {\n        \"score\": 9.8,\n        \"vectorString\": \"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H\"\n      },\n      \"updated\": \"2022-04-04T21:39:39.000Z\",\n      \"recommendation\": \"Upgrade to version 1.2.6 or later\",\n      \"cwe\": [\n        \"CWE-1321\"\n      ],\n      \"found_by\": null,\n      \"deleted\": null,\n      \"id\": 1067342,\n      \"references\": \"- https://nvd.nist.gov/vuln/detail/CVE-2021-44906\\n- https://github.com/substack/minimist/issues/164\\n- https://github.com/substack/minimist/blob/master/index.js#L69\\n- https://snyk.io/vuln/SNYK-JS-MINIMIST-559764\\n- https://stackoverflow.com/questions/8588563/adding-custom-properties-to-a-function/20278068#20278068\\n- https://github.com/Marynk/JavaScript-vulnerability-detection/blob/main/minimist%20PoC.zip\\n- https://github.com/advisories/GHSA-xvch-5gv4-984h\",\n      \"created\": \"2022-03-18T00:01:09.000Z\",\n      \"reported_by\": null,\n      \"title\": \"Prototype Pollution in minimist\",\n      \"npm_advisory_id\": null,\n      \"overview\": \"Minimist <=1.2.5 is vulnerable to Prototype Pollution via file index.js, function setKey() (lines 69-95).\",\n      \"url\": \"https://github.com/advisories/GHSA-xvch-5gv4-984h\"\n    },\n    \"1067363\": {\n      \"findings\": [\n        {\n          \"version\": \"1.2.0\",\n          \"paths\": [\n            \"@angular-devkit/build-angular>webpack-dev-server>selfsigned>node-forge\"\n          ]\n        }\n      ],\n      \"metadata\": null,\n      \"vulnerable_versions\": \"<1.3.0\",\n      \"module_name\": \"node-forge\",\n      \"severity\": \"moderate\",\n      \"github_advisory_id\": \"GHSA-2r2c-g63r-vccr\",\n      \"cves\": [\n        \"CVE-2022-24773\"\n      ],\n      \"access\": \"public\",\n      \"patched_versions\": \">=1.3.0\",\n      \"cvss\": {\n        \"score\": 5.3,\n        \"vectorString\": \"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:N\"\n      },\n      \"updated\": \"2022-03-22T19:33:03.000Z\",\n      \"recommendation\": \"Upgrade to version 1.3.0 or later\",\n      \"cwe\": [\n        \"CWE-347\"\n      ],\n      \"found_by\": null,\n      \"deleted\": null,\n      \"id\": 1067363,\n      \"references\": \"- https://github.com/digitalbazaar/forge/security/advisories/GHSA-2r2c-g63r-vccr\\n- https://nvd.nist.gov/vuln/detail/CVE-2022-24773\\n- https://github.com/digitalbazaar/forge/commit/3f0b49a0573ef1bb7af7f5673c0cfebf00424df1\\n- https://github.com/digitalbazaar/forge/commit/bb822c02df0b61211836472e29b9790cc541cdb2\\n- https://github.com/advisories/GHSA-2r2c-g63r-vccr\",\n      \"created\": \"2022-03-18T23:10:48.000Z\",\n      \"reported_by\": null,\n      \"title\": \"Improper Verification of Cryptographic Signature in `node-forge`\",\n      \"npm_advisory_id\": null,\n      \"overview\": \"### Impact\\n\\nRSA PKCS#1 v1.5 signature verification code is not properly checking `DigestInfo` for a proper ASN.1 structure. This can lead to successful verification with signatures that contain invalid structures but a valid digest.\\n\\n### Patches\\n\\nThe issue has been addressed in `node-forge` `1.3.0`.\\n\\n### For more information\\n\\nIf you have any questions or comments about this advisory:\\n* Open an issue in [forge](https://github.com/digitalbazaar/forge)\\n* Email us at [example email address](mailto:security@digitalbazaar.com)\",\n      \"url\": \"https://github.com/advisories/GHSA-2r2c-g63r-vccr\"\n    },\n    \"1067364\": {\n      \"findings\": [\n        {\n          \"version\": \"1.2.0\",\n          \"paths\": [\n            \"@angular-devkit/build-angular>webpack-dev-server>selfsigned>node-forge\"\n          ]\n        }\n      ],\n      \"metadata\": null,\n      \"vulnerable_versions\": \"<1.3.0\",\n      \"module_name\": \"node-forge\",\n      \"severity\": \"high\",\n      \"github_advisory_id\": \"GHSA-cfm4-qjh2-4765\",\n      \"cves\": [\n        \"CVE-2022-24771\"\n      ],\n      \"access\": \"public\",\n      \"patched_versions\": \">=1.3.0\",\n      \"cvss\": {\n        \"score\": 7.5,\n        \"vectorString\": \"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N\"\n      },\n      \"updated\": \"2022-03-22T19:33:47.000Z\",\n      \"recommendation\": \"Upgrade to version 1.3.0 or later\",\n      \"cwe\": [\n        \"CWE-347\"\n      ],\n      \"found_by\": null,\n      \"deleted\": null,\n      \"id\": 1067364,\n      \"references\": \"- https://github.com/digitalbazaar/forge/security/advisories/GHSA-cfm4-qjh2-4765\\n- https://nvd.nist.gov/vuln/detail/CVE-2022-24771\\n- https://github.com/digitalbazaar/forge/commit/3f0b49a0573ef1bb7af7f5673c0cfebf00424df1\\n- https://github.com/digitalbazaar/forge/commit/bb822c02df0b61211836472e29b9790cc541cdb2\\n- https://github.com/advisories/GHSA-cfm4-qjh2-4765\",\n      \"created\": \"2022-03-18T23:09:54.000Z\",\n      \"reported_by\": null,\n      \"title\": \"Improper Verification of Cryptographic Signature in node-forge\",\n      \"npm_advisory_id\": null,\n      \"overview\": \"### Impact\\n\\nRSA PKCS#1 v1.5 signature verification code is lenient in checking the digest algorithm structure. This can allow a crafted structure that steals padding bytes and uses unchecked portion of the PKCS#1 encoded message to forge a signature when a low public exponent is being used.\\n\\n### Patches\\n\\nThe issue has been addressed in `node-forge` `1.3.0`.\\n\\n### References\\n\\nFor more information, please see\\n[\\\"Bleichenbacher's RSA signature forgery based on implementation error\\\"](https://mailarchive.ietf.org/arch/msg/openpgp/5rnE9ZRN1AokBVj3VqblGlP63QE/)\\nby Hal Finney.\\n\\n### For more information\\n\\nIf you have any questions or comments about this advisory:\\n* Open an issue in [forge](https://github.com/digitalbazaar/forge)\\n* Email us at [example email address](mailto:security@digitalbazaar.com)\",\n      \"url\": \"https://github.com/advisories/GHSA-cfm4-qjh2-4765\"\n    },\n    \"1070206\": {\n      \"findings\": [\n        {\n          \"version\": \"2.6.3\",\n          \"paths\": [\n            \"@angular-devkit/build-angular>webpack-dev-server>portfinder>async\"\n          ]\n        },\n        {\n          \"version\": \"0.9.2\",\n          \"paths\": [\n            \"@angular-eslint/builder>@nrwl/devkit>ejs>jake>async\"\n          ]\n        },\n        {\n          \"version\": \"0.9.2\",\n          \"paths\": [\n            \"mail-listener2>async\"\n          ]\n        },\n        {\n          \"version\": \"2.6.3\",\n          \"paths\": [\n            \"protractor-jasmine2-parallel-html-reporter>protractor-jasmine2-html-reporter>async\"\n          ]\n        }\n      ],\n      \"metadata\": null,\n      \"vulnerable_versions\": \"<2.6.4\",\n      \"module_name\": \"async\",\n      \"severity\": \"high\",\n      \"github_advisory_id\": \"GHSA-fwr7-v2mv-hh25\",\n      \"cves\": [\n        \"CVE-2021-43138\"\n      ],\n      \"access\": \"public\",\n      \"patched_versions\": \">=2.6.4\",\n      \"cvss\": {\n        \"score\": 7.8,\n        \"vectorString\": \"CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H\"\n      },\n      \"updated\": \"2022-04-20T19:12:25.000Z\",\n      \"recommendation\": \"Upgrade to version 2.6.4 or later\",\n      \"cwe\": [\n        \"CWE-1321\"\n      ],\n      \"found_by\": null,\n      \"deleted\": null,\n      \"id\": 1070206,\n      \"references\": \"- https://nvd.nist.gov/vuln/detail/CVE-2021-43138\\n- https://github.com/caolan/async/commit/e1ecdbf79264f9ab488c7799f4c76996d5dca66d\\n- https://github.com/caolan/async/blob/master/lib/internal/iterator.js\\n- https://github.com/caolan/async/blob/master/lib/mapValuesLimit.js\\n- https://jsfiddle.net/oz5twjd9/\\n- https://github.com/caolan/async/pull/1828\\n- https://github.com/caolan/async/commit/8f7f90342a6571ba1c197d747ebed30c368096d2\\n- https://github.com/caolan/async/blob/v2.6.4/CHANGELOG.md#v264\\n- https://github.com/advisories/GHSA-fwr7-v2mv-hh25\",\n      \"created\": \"2022-04-07T00:00:17.000Z\",\n      \"reported_by\": null,\n      \"title\": \"Prototype Pollution in async\",\n      \"npm_advisory_id\": null,\n      \"overview\": \"A vulnerability exists in Async through 3.2.1 for 3.x and through 2.6.3 for 2.x (fixed in 3.2.2 and 2.6.4), which could let a malicious user obtain privileges via the `mapValues()` method.\",\n      \"url\": \"https://github.com/advisories/GHSA-fwr7-v2mv-hh25\"\n    },\n    \"1070207\": {\n      \"findings\": [\n        {\n          \"version\": \"3.2.0\",\n          \"paths\": [\n            \"karma-typescript>async\"\n          ]\n        },\n        {\n          \"version\": \"3.2.1\",\n          \"paths\": [\n            \"pdf2json>async\"\n          ]\n        }\n      ],\n      \"metadata\": null,\n      \"vulnerable_versions\": \">=3.0.0 <3.2.2\",\n      \"module_name\": \"async\",\n      \"severity\": \"high\",\n      \"github_advisory_id\": \"GHSA-fwr7-v2mv-hh25\",\n      \"cves\": [\n        \"CVE-2021-43138\"\n      ],\n      \"access\": \"public\",\n      \"patched_versions\": \">=3.2.2\",\n      \"cvss\": {\n        \"score\": 7.8,\n        \"vectorString\": \"CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H\"\n      },\n      \"updated\": \"2022-04-20T19:12:25.000Z\",\n      \"recommendation\": \"Upgrade to version 3.2.2 or later\",\n      \"cwe\": [\n        \"CWE-1321\"\n      ],\n      \"found_by\": null,\n      \"deleted\": null,\n      \"id\": 1070207,\n      \"references\": \"- https://nvd.nist.gov/vuln/detail/CVE-2021-43138\\n- https://github.com/caolan/async/commit/e1ecdbf79264f9ab488c7799f4c76996d5dca66d\\n- https://github.com/caolan/async/blob/master/lib/internal/iterator.js\\n- https://github.com/caolan/async/blob/master/lib/mapValuesLimit.js\\n- https://jsfiddle.net/oz5twjd9/\\n- https://github.com/caolan/async/pull/1828\\n- https://github.com/caolan/async/commit/8f7f90342a6571ba1c197d747ebed30c368096d2\\n- https://github.com/caolan/async/blob/v2.6.4/CHANGELOG.md#v264\\n- https://github.com/advisories/GHSA-fwr7-v2mv-hh25\",\n      \"created\": \"2022-04-07T00:00:17.000Z\",\n      \"reported_by\": null,\n      \"title\": \"Prototype Pollution in async\",\n      \"npm_advisory_id\": null,\n      \"overview\": \"A vulnerability exists in Async through 3.2.1 for 3.x and through 2.6.3 for 2.x (fixed in 3.2.2 and 2.6.4), which could let a malicious user obtain privileges via the `mapValues()` method.\",\n      \"url\": \"https://github.com/advisories/GHSA-fwr7-v2mv-hh25\"\n    },\n    \"1070245\": {\n      \"findings\": [\n        {\n          \"version\": \"2.29.1\",\n          \"paths\": [\n            \"moment\"\n          ]\n        }\n      ],\n      \"metadata\": null,\n      \"vulnerable_versions\": \"<2.29.2\",\n      \"module_name\": \"moment\",\n      \"severity\": \"high\",\n      \"github_advisory_id\": \"GHSA-8hfj-j24r-96c4\",\n      \"cves\": [\n        \"CVE-2022-24785\"\n      ],\n      \"access\": \"public\",\n      \"patched_versions\": \">=2.29.2\",\n      \"cvss\": {\n        \"score\": 7.5,\n        \"vectorString\": \"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N\"\n      },\n      \"updated\": \"2022-04-26T20:56:20.000Z\",\n      \"recommendation\": \"Upgrade to version 2.29.2 or later\",\n      \"cwe\": [\n        \"CWE-22\",\n        \"CWE-27\"\n      ],\n      \"found_by\": null,\n      \"deleted\": null,\n      \"id\": 1070245,\n      \"references\": \"- https://github.com/moment/moment/security/advisories/GHSA-8hfj-j24r-96c4\\n- https://nvd.nist.gov/vuln/detail/CVE-2022-24785\\n- https://github.com/moment/moment/commit/4211bfc8f15746be4019bba557e29a7ba83d54c5\\n- https://www.tenable.com/security/tns-2022-09\\n- https://github.com/advisories/GHSA-8hfj-j24r-96c4\",\n      \"created\": \"2022-04-04T21:25:48.000Z\",\n      \"reported_by\": null,\n      \"title\": \"Path Traversal: 'dir/../../filename' in moment.locale\",\n      \"npm_advisory_id\": null,\n      \"overview\": \"### Impact\\nThis vulnerability impacts npm (server) users of moment.js, especially if user provided locale string, eg `fr` is directly used to switch moment locale.\\n\\n### Patches\\nThis problem is patched in 2.29.2, and the patch can be applied to all affected versions (from 1.0.1 up until 2.29.1, inclusive).\\n\\n### Workarounds\\nSanitize user-provided locale name before passing it to moment.js.\\n\\n### References\\n_Are there any links users can visit to find out more?_\\n\\n### For more information\\nIf you have any questions or comments about this advisory:\\n* Open an issue in [moment repo](https://github.com/moment/moment)\\n\",\n      \"url\": \"https://github.com/advisories/GHSA-8hfj-j24r-96c4\"\n    },\n    \"1070256\": {\n      \"findings\": [\n        {\n          \"version\": \"3.1.6\",\n          \"paths\": [\n            \"@angular-eslint/builder>@nrwl/devkit>ejs\"\n          ]\n        }\n      ],\n      \"metadata\": null,\n      \"vulnerable_versions\": \"<3.1.7\",\n      \"module_name\": \"ejs\",\n      \"severity\": \"high\",\n      \"github_advisory_id\": \"GHSA-phwq-j96m-2c2q\",\n      \"cves\": [\n        \"CVE-2022-29078\"\n      ],\n      \"access\": \"public\",\n      \"patched_versions\": \">=3.1.7\",\n      \"cvss\": {\n        \"score\": 0,\n        \"vectorString\": null\n      },\n      \"updated\": \"2022-04-27T14:36:25.000Z\",\n      \"recommendation\": \"Upgrade to version 3.1.7 or later\",\n      \"cwe\": [\n        \"CWE-74\"\n      ],\n      \"found_by\": null,\n      \"deleted\": null,\n      \"id\": 1070256,\n      \"references\": \"- https://nvd.nist.gov/vuln/detail/CVE-2022-29078\\n- https://eslam.io/posts/ejs-server-side-template-injection-rce/\\n- https://github.com/mde/ejs/commit/15ee698583c98dadc456639d6245580d17a24baf\\n- https://github.com/advisories/GHSA-phwq-j96m-2c2q\",\n      \"created\": \"2022-04-26T00:00:40.000Z\",\n      \"reported_by\": null,\n      \"title\": \"Template injection in ejs\",\n      \"npm_advisory_id\": null,\n      \"overview\": \"The ejs (aka Embedded JavaScript templates) package 3.1.6 for Node.js allows server-side template injection in settings[view options][outputFunctionName]. This is parsed as an internal option, and overwrites the outputFunctionName option with an arbitrary OS command (which is executed upon template compilation).\",\n      \"url\": \"https://github.com/advisories/GHSA-phwq-j96m-2c2q\"\n    }\n  },\n  \"muted\": [],\n  \"metadata\": {\n    \"vulnerabilities\": {\n      \"info\": 0,\n      \"low\": 0,\n      \"moderate\": 1,\n      \"high\": 10,\n      \"critical\": 6\n    },\n    \"dependencies\": 527,\n    \"devDependencies\": 1302,\n    \"optionalDependencies\": 48,\n    \"totalDependencies\": 1835\n  },\n  \"runId\": \"dd291f68-0911-468e-ac48-f71e10c11f31\"\n}\n"

	verb, format := formats.DetectVerbAndFormat(vector, stderr.Output{})
	assert.Equal(t, formats.AuditCommand, verb)
	assert.Equal(t, formats.JsonFormat, format)

	previousInjectValue := shared.InjectPackageManager
	defer func() { shared.InjectPackageManager = previousInjectValue }()
	shared.InjectPackageManager = true
	result, err := ParseAuditOutput(vector, stderr.Output{})

	assert.Nil(t, err)
	// there are 8 advisories relating to 17 vulnerabilities in 5 packages
	assert.Equal(t, 5, len(result))

	item := result[0]
	assert.Equal(t, "npm", item.PackageManager)
	assert.Equal(t, "async", item.Name)
	assert.Equal(t, 2, len(item.Advisories))

	advisory := item.Advisories[0]
	assert.Equal(t, 7.8, advisory.CVSSScore)
	assert.Equal(t, "1070206", advisory.Identifier)
	assert.Equal(t, "A vulnerability exists in Async through 3.2.1 for 3.x and through 2.6.3 for 2.x (fixed in 3.2.2 and 2.6.4), which could let a malicious user obtain privileges via the `mapValues()` method.", advisory.Overview)
	assert.Equal(t, ">=2.6.4", advisory.PatchedVersions)
	assert.Equal(t, "Upgrade to version 2.6.4 or later", advisory.Recommendation)
	assert.Equal(t, "high", advisory.Severity)
	assert.Equal(t, "Prototype Pollution in async", advisory.Title)
	assert.Equal(t, "https://github.com/advisories/GHSA-fwr7-v2mv-hh25", advisory.Url)
	assert.Equal(t, "<2.6.4", advisory.VulnerableVersions)

	advisory = item.Advisories[1]
	assert.Equal(t, 7.8, advisory.CVSSScore)
	assert.Equal(t, "1070207", advisory.Identifier)
	assert.Equal(t, "A vulnerability exists in Async through 3.2.1 for 3.x and through 2.6.3 for 2.x (fixed in 3.2.2 and 2.6.4), which could let a malicious user obtain privileges via the `mapValues()` method.", advisory.Overview)
	assert.Equal(t, ">=3.2.2", advisory.PatchedVersions)
	assert.Equal(t, "Upgrade to version 3.2.2 or later", advisory.Recommendation)
	assert.Equal(t, "high", advisory.Severity)
	assert.Equal(t, "Prototype Pollution in async", advisory.Title)
	assert.Equal(t, "https://github.com/advisories/GHSA-fwr7-v2mv-hh25", advisory.Url)
	assert.Equal(t, ">=3.0.0 <3.2.2", advisory.VulnerableVersions)
}

func TestParseAuditOutput_InvalidJson(t *testing.T) {
	vector := "{ test"

	result, err := ParseAuditOutput(vector, stderr.Output{})

	assert.NotNil(t, err)
	assert.Contains(t, err.Error(), "unable to parse JSON")
	assert.Zero(t, len(result))
}
